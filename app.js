const express = require('express')
const bodyParser = require('body-parser')
const fetch = require("node-fetch")


const app = express()

app.use(bodyParser.json())
const port = 3000

app.all('/', async (req, response) => {
  console.log(req.body)
  const originSrc = req.body.url    //" https://v.douyin.com/JbV49Hw/"
  if(originSrc == undefined) {
    response.json({ info: 'not fount url' })
  }

  res = await fetch(originSrc)
  str = res.url
  // const str = "https://www.iesdouyin.com/share/video/6908977540770090253/?region=CN&mid=6908977607640566542&u_code=h469mif0&titleType=title&did=70277320206&iid=3447715017526420&utm_source=copy_link&utm_campaign=client_share&utm_medium=android&app=aweme"
  temStr1 = str.split("video/")
  temStr2 = temStr1[1].split("/?region")
  videoId = temStr2[0]


  item = await fetch("https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids=" + videoId)
  res = await item.json()
  // res = { "status_code": 0, "item_list": [{ "statistics": { "aweme_id": "6908977540770090253", "comment_count": 276, "digg_count": 669525, "play_count": 0 }, "risk_infos": { "warn": false, "type": 0, "content": "" }, "author_user_id": 166743642223588, "video_text": null, "is_live_replay": false, "duration": 12886, "comment_list": null, "author": { "uid": "166743642223588", "unique_id": "Jiangsuguangbo", "geofencing": null, "policy_version": null, "avatar_medium": { "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8", "url_list": ["https://p6-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_720x720.jpeg?from=4010531038", "https://p26-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_720x720.jpeg?from=4010531038", "https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_720x720.jpeg?from=4010531038"] }, "followers_detail": null, "platform_sync_info": null, "short_id": "3591982649", "nickname": "江苏广播", "signature": "江苏广播，时刻与你同在！", "avatar_larger": { "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8", "url_list": ["https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038", "https://p3-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038", "https://p6-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038"] }, "avatar_thumb": { "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8", "url_list": ["https://p6-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_100x100.jpeg?from=4010531038", "https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_100x100.jpeg?from=4010531038", "https://p26-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_100x100.jpeg?from=4010531038"] }, "type_label": null }, "share_url": "https://www.iesdouyin.com/share/video/6908977540770090253/?region=&mid=6908977607640566542&u_code=48&titleType=title&did=0&iid=0", "text_extra": [{ "start": 0, "end": 17, "type": 1, "hashtag_name": "结婚23年后妻子被医学证明是男人", "hashtag_id": 1686761986945031 }], "image_infos": null, "create_time": 1608621706, "share_info": { "share_weibo_desc": "#在抖音，记录美好生活##结婚23年后妻子被医学证明是男人 ，丈夫得知真相后懵了", "share_desc": "在抖音，记录美好生活", "share_title": "#结婚23年后妻子被医学证明是男人 ，丈夫得知真相后懵了" }, "label_top_text": null, "promotions": null, "forward_id": "0", "aweme_id": "6908977540770090253", "is_preview": 0, "cha_list": [{ "desc": "", "user_count": 0, "connect_music": null, "view_count": 0, "is_commerce": false, "cid": "1686761986945031", "type": 1, "hash_tag_profile": "", "cha_name": "结婚23年后妻子被医学证明是男人" }], "video": { "height": 960, "origin_cover": { "uri": "tos-cn-p-0015/398970b8d85348ff9e69615c6a63d1e8_1608621707", "url_list": ["https://p5-dy-ipv6.byteimg.com/tos-cn-p-0015/398970b8d85348ff9e69615c6a63d1e8_1608621707~tplv-dy-360p.jpeg?from=2563711402", "https://p6-dy-ipv6.byteimg.com/tos-cn-p-0015/398970b8d85348ff9e69615c6a63d1e8_1608621707~tplv-dy-360p.jpeg?from=2563711402", "https://p3-dy-ipv6.byteimg.com/tos-cn-p-0015/398970b8d85348ff9e69615c6a63d1e8_1608621707~tplv-dy-360p.jpeg?from=2563711402"] }, "duration": 12886, "vid": "v0300f060000bvgpsqv4or9vo783ojdg", "ratio": "540p", "has_watermark": true, "bit_rate": null, "play_addr": { "url_list": ["https://aweme.snssdk.com/aweme/v1/playwm/?video_id=v0300f060000bvgpsqv4or9vo783ojdg&ratio=720p&line=0"], "uri": "v0300f060000bvgpsqv4or9vo783ojdg" }, "cover": { "uri": "tos-cn-p-0015/34480a4256864786846807e3d5c7e926_1608621709", "url_list": ["https://p3-dy-ipv6.byteimg.com/img/tos-cn-p-0015/34480a4256864786846807e3d5c7e926_1608621709~tplv-dmt-logomcc:tos-cn-i-0813/ba12cd233230416d8acee028f62a3c51:300:400.jpeg?from=2563711402_large", "https://p1-dy-ipv6.byteimg.com/img/tos-cn-p-0015/34480a4256864786846807e3d5c7e926_1608621709~tplv-dmt-logomcc:tos-cn-i-0813/ba12cd233230416d8acee028f62a3c51:300:400.jpeg?from=2563711402_large", "https://p9-dy.byteimg.com/img/tos-cn-p-0015/34480a4256864786846807e3d5c7e926_1608621709~tplv-dmt-logomcc:tos-cn-i-0813/ba12cd233230416d8acee028f62a3c51:300:400.jpeg?from=2563711402_large"] }, "width": 544, "dynamic_cover": { "uri": "tos-cn-p-0015/56f974fce4034cbc954a53e4ca2fcbd5_1608621707", "url_list": ["https://p29-dy.byteimg.com/img/tos-cn-p-0015/56f974fce4034cbc954a53e4ca2fcbd5_1608621707~tplv-dmt-logom:tos-cn-i-0813/ba12cd233230416d8acee028f62a3c51.image?from=2563711402_large", "https://p5-dy-ipv6.byteimg.com/img/tos-cn-p-0015/56f974fce4034cbc954a53e4ca2fcbd5_1608621707~tplv-dmt-logom:tos-cn-i-0813/ba12cd233230416d8acee028f62a3c51.image?from=2563711402_large", "https://p3-dy-ipv6.byteimg.com/img/tos-cn-p-0015/56f974fce4034cbc954a53e4ca2fcbd5_1608621707~tplv-dmt-logom:tos-cn-i-0813/ba12cd233230416d8acee028f62a3c51.image?from=2563711402_large"] } }, "video_labels": null, "group_id": 6908977540770090000, "music": { "mid": "6908977607640566542", "author": "江苏广播", "cover_hd": { "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8", "url_list": ["https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038", "https://p6-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038", "https://p26-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038"] }, "cover_large": { "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8", "url_list": ["https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038", "https://p6-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038", "https://p26-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_1080x1080.jpeg?from=4010531038"] }, "cover_medium": { "url_list": ["https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_720x720.jpeg?from=4010531038", "https://p3-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_720x720.jpeg?from=4010531038", "https://p1-dy-ipv6.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_720x720.jpeg?from=4010531038"], "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8" }, "cover_thumb": { "uri": "tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8", "url_list": ["https://p26-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_168x168.webp?from=4010531038", "https://p29-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_168x168.webp?from=4010531038", "https://p3-dy-ipv6-test.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_168x168.webp?from=4010531038", "https://p26-dy.byteimg.com/img/tos-cn-avt-0015/7b59a1854dd864e409d9c17e2d53bec8~c5_168x168.jpeg?from=4010531038"] }, "duration": 12, "id": 6908977607640567000, "play_url": { "uri": "https://sf3-dycdn-tos.pstatp.com/obj/ies-music/6908977598765419277.mp3", "url_list": ["https://sf3-dycdn-tos.pstatp.com/obj/ies-music/6908977598765419277.mp3", "https://sf6-dycdn-tos.pstatp.com/obj/ies-music/6908977598765419277.mp3"] }, "position": null, "status": 1, "title": "@江苏广播创作的原声" }, "aweme_type": 4, "long_video": null, "desc": "#结婚23年后妻子被医学证明是男人 ，丈夫得知真相后懵了", "geofencing": null }], "extra": { "now": 1608632776000, "logid": "202012221826150101980620710E08B49B" } }
  videoUrl = res.item_list[0].video.play_addr.url_list[0].replace(/playwm/g, "play")

  response.json({ newUrl: videoUrl })
})

app.listen(port, () => {
  console.log(`Example app listening at http://localhost:${port}`)
})